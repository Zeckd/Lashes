<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mega Lashes - –û–Ω–ª–∞–π–Ω –ó–∞–ø–∏—Å—å</title>
    <style>
        /* === CSS Styles === */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        header { background-color: #ff69b4; color: white; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 24px; }
        nav button { background-color: white; color: #ff69b4; border: none; padding: 8px 15px; margin-left: 10px; cursor: pointer; border-radius: 4px; transition: background-color 0.3s; }
        nav button:hover { background-color: #ffe0f0; }
        main { padding: 20px; max-width: 1200px; margin: 20px auto; background-color: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .hidden { display: none; }

        /* Forms */
        form { display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        input[type="text"], input[type="password"], input[type="email"], input[type="date"], select, button[type="submit"], textarea { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button[type="submit"] { background-color: #ff69b4; color: white; border: none; cursor: pointer; transition: background-color 0.3s; }
        button[type="submit"]:hover { background-color: #e65a9a; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: 4px; text-align: center; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }

        /* Admin/User Panels */
        .panel { padding: 20px; border: 1px solid #eee; border-radius: 5px; margin-top: 20px; }
        .stat-box { background-color: #ffe0f0; padding: 15px; border-radius: 5px; margin: 10px; text-align: center; }
        .flex-container { display: flex; flex-wrap: wrap; justify-content: space-around; }
        .action-button { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; margin-right: 5px; cursor: pointer; border-radius: 3px; }
        .action-button.delete { background-color: #f44336; }
        .action-button.update { background-color: #2196F3; }

        /* Time slots */
        .time-slot { padding: 8px; margin: 5px; border: 1px solid #ff69b4; border-radius: 4px; cursor: pointer; display: inline-block; background-color: #fff; }
        .time-slot.selected { background-color: #ff69b4; color: white; }
    </style>
</head>
<body>

<header>
    <h1>üíÖ Mega Lashes</h1>
    <nav>
        <button id="nav-home" onclick="showSection('home')">–ì–ª–∞–≤–Ω–∞—è</button>
        <button id="nav-login" onclick="showSection('login')">–í—Ö–æ–¥</button>
        <button id="nav-register" onclick="showSection('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="nav-user-panel" class="hidden" onclick="showSection('user-panel')">–ú–æ–∏ –ó–∞–ø–∏—Å–∏</button>
        <button id="nav-admin-panel" class="hidden" onclick="showSection('admin-panel')">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</button>
        <button id="nav-logout" class="hidden" onclick="logout()">–í—ã—Ö–æ–¥</button>
    </nav>
</header>

<main>
    <section id="home" class="section">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p>–°–∏—Å—Ç–µ–º–∞ –æ–Ω–ª–∞–π–Ω-–∑–∞–ø–∏—Å–∏ –Ω–∞ –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü.</p>
    </section>

    <section id="login" class="section hidden">
        <h2>üîë –í—Ö–æ–¥</h2>
        <div id="login-message" class="message hidden"></div>
        <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <label><input type="checkbox" id="login-remember"> –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
            <button type="submit">–í–æ–π—Ç–∏</button>
            <button type="button" onclick="showSection('forgot-password')">–ó–∞–±—ã–ª –ø–∞—Ä–æ–ª—å?</button>
        </form>
    </section>

    <section id="register" class="section hidden">
        <h2>üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <div id="register-message" class="message hidden"></div>
        <form id="register-form">
            <input type="text" id="register-name" placeholder="–ò–º—è" required>
            <input type="email" id="register-email" placeholder="Email" required>
            <input type="text" id="register-phone" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" required>
            <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <input type="password" id="register-confirm-password" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è" required>
            <label><input type="checkbox" id="register-remember"> –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
            <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </form>
    </section>

    <section id="forgot-password" class="section hidden">
        <h2>‚ùì –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h2>
        <p>–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π email, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å–±—Ä–æ—Å–∞.</p>
        <div id="forgot-message" class="message hidden"></div>
        <form id="forgot-password-form">
            <input type="email" id="forgot-email" placeholder="Email" required>
            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</button>
        </form>
    </section>

    <section id="reset-password" class="section hidden">
        <h2>üîÑ –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h2>
        <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –Ω–∞ email, –∏ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.</p>
        <div id="reset-message" class="message hidden"></div>
        <form id="reset-password-form">
            <input type="text" id="reset-token" placeholder="–ö–æ–¥ —Å–±—Ä–æ—Å–∞" required>
            <input type="password" id="reset-new-password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
            <button type="submit">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        </form>
    </section>

    <section id="user-panel" class="section hidden">
        <h2>üë§ –ü–∞–Ω–µ–ª—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <div id="user-info"></div>

        <div class="panel">
            <h3>üìÖ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h3>
            <div id="appointment-create-message" class="message hidden"></div>
            <form id="appointment-create-form">
                <input type="text" id="app-client-name" placeholder="–í–∞—à–µ –∏–º—è" required>
                <input type="text" id="app-client-phone" placeholder="–í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω" required>
                <input type="date" id="app-date" required onchange="loadAvailableTimes()">
                <div id="available-times-container">
                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.</p>
                </div>
                <input type="hidden" id="app-time" required>

                <textarea id="app-notes" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∑–∞–ø–∏—Å–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)"></textarea>

                <button type="submit">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
            </form>
        </div>

        <div class="panel">
            <h3>‚è≥ –ú–æ–∏ –∑–∞–ø–∏—Å–∏</h3>
            <table>
                <thead>
                <tr><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr>
                </thead>
                <tbody id="my-appointments-table">
                </tbody>
            </table>
        </div>
    </section>

    <section id="admin-panel" class="section hidden">
        <h2>üëë –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

        <div class="panel">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ó–∞–ø–∏—Å–µ–π</h3>
            <div id="statistics" class="flex-container">
            </div>
        </div>

        <div class="panel">
            <h3>üìù –í—Å–µ –ó–∞–ø–∏—Å–∏</h3>
            <table>
                <thead>
                <tr><th>ID</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–î–∞—Ç–∞</th><th>–í—Ä–µ–º—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                </thead>
                <tbody id="all-appointments-table">
                </tbody>
            </table>
        </div>

        <div class="panel">
            <h3>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
            <table>
                <thead>
                <tr><th>ID</th><th>–ò–º—è</th><th>Email</th><th>–†–æ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
                </thead>
                <tbody id="users-table">
                </tbody>
            </table>
        </div>
    </section>

</main>

<script>
    // === JavaScript Logic ===

    const API_BASE_URL = 'http://localhost:8080/api'; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤–∞—à–µ–≥–æ Spring Boot –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!

    // --- Utility Functions ---

    /** –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞) –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
    function showMessage(containerId, message, isError = false) {
        const container = document.getElementById(containerId);
        container.textContent = message;
        container.className = `message ${isError ? 'error' : 'success'}`;
        container.classList.remove('hidden');
    }

    /** –°–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ */
    function hideMessage(containerId) {
        document.getElementById(containerId).classList.add('hidden');
    }

    /** –ü–æ–ª—É—á–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω –∏–∑ localStorage */
    function getToken() {
        return localStorage.getItem('token');
    }

    /** –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ localStorage */
    function getCurrentUser() {
        const userJson = localStorage.getItem('user');
        return userJson ? JSON.parse(userJson) : null;
    }

    /** –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ */
    function getAuthHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
        };
    }

    // --- Navigation and State Management ---

    /** –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Ä–æ–ª–∏ */
    function updateNav() {
        const token = getToken();
        const user = getCurrentUser();

        const isAuthenticated = !!token && !!user;
        const isAdmin = isAuthenticated && user.role === 'ADMIN';

        document.getElementById('nav-login').classList.toggle('hidden', isAuthenticated);
        document.getElementById('nav-register').classList.toggle('hidden', isAuthenticated);
        document.getElementById('nav-logout').classList.toggle('hidden', !isAuthenticated);
        document.getElementById('nav-user-panel').classList.toggle('hidden', !isAuthenticated || isAdmin);
        document.getElementById('nav-admin-panel').classList.toggle('hidden', !isAdmin);
    }

    /** –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–µ–∫—Ü–∏–π */
    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.add('hidden');
        });
        document.getElementById(sectionId).classList.remove('hidden');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –ø–∞–Ω–µ–ª—å
        if (sectionId === 'user-panel') {
            loadMyAppointments();
        } else if (sectionId === 'admin-panel') {
            loadStatistics();
            loadAllAppointments();
            loadAllUsers();
        }

        // –û—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
        hideMessage('login-message');
        hideMessage('register-message');
        hideMessage('forgot-message');
        hideMessage('reset-message');
        hideMessage('appointment-create-message');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        if ((sectionId === 'user-panel' || sectionId === 'admin-panel') && !getToken()) {
            showMessage('home-message', '–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.', true);
            showSection('home');
        }
    }

    /** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    function init() {
        updateNav();
        const token = getToken();
        if (token) {
            const user = getCurrentUser();
            if (user.role === 'ADMIN') {
                showSection('admin-panel');
            } else {
                showSection('user-panel');
            }
        } else {
            showSection('home');
        }
    }

    // --- Auth Functions ---

    /** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ */
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessage('login-message');

        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const rememberMe = document.getElementById('login-remember').checked;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, rememberMe })
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                showMessage('login-message', data.message, false);
                updateNav();
                if (data.user.role === 'ADMIN') {
                    showSection('admin-panel');
                } else {
                    showSection('user-panel');
                }
            } else {
                showMessage('login-message', data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', true);
            }
        } catch (error) {
            showMessage('login-message', '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', true);
        }
    });

    /** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessage('register-message');

        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const phoneNumber = document.getElementById('register-phone').value;
        const password = document.getElementById('register-password').value;
        const confirmPassword = document.getElementById('register-confirm-password').value;
        const rememberMe = document.getElementById('register-remember').checked;

        if (password !== confirmPassword) {
            showMessage('register-message', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', true);
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, phoneNumber, password, confirmPassword, rememberMe })
            });

            const data = await response.json();

            if (response.ok) {
                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));
                showMessage('register-message', data.message, false);
                updateNav();
                showSection('user-panel');
            } else {
                showMessage('register-message', data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', true);
            }
        } catch (error) {
            showMessage('register-message', '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', true);
        }
    });

    /** –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã */
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        updateNav();
        showSection('home');
        fetch(`${API_BASE_URL}/auth/logout`, { method: 'POST' }); // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    }

    // --- Forgot Password Functions ---

    /** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –∫–æ–¥–∞ —Å–±—Ä–æ—Å–∞ */
    document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessage('forgot-message');

        const email = document.getElementById('forgot-email').value;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/forgot-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('forgot-message', data.message, false);
                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É —Å–±—Ä–æ—Å–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
                setTimeout(() => showSection('reset-password'), 2000);
            } else {
                showMessage('forgot-message', data.error || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å–±—Ä–æ—Å–∞', true);
            }
        } catch (error) {
            showMessage('forgot-message', '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', true);
        }
    });

    /** –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è */
    document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessage('reset-message');

        const token = document.getElementById('reset-token').value;
        const newPassword = document.getElementById('reset-new-password').value;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/reset-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, newPassword })
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('reset-message', data.message + '. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.', false);
                setTimeout(() => showSection('login'), 2000);
            } else {
                showMessage('reset-message', data.error || '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è', true);
            }
        } catch (error) {
            showMessage('reset-message', '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', true);
        }
    });

    // --- User Appointment Functions ---

    /** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–∏ */
    async function loadAvailableTimes() {
        const date = document.getElementById('app-date').value;
        const container = document.getElementById('available-times-container');
        container.innerHTML = '';
        document.getElementById('app-time').value = ''; // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

        if (!date) return;

        try {
            const response = await fetch(`${API_BASE_URL}/appointments/taken-times?date=${date}`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                container.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.</p>';
                return;
            }

            const takenTimes = await response.json();

            // –ü—Ä–∏–º–µ—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ (—Å 9:00 –¥–æ 18:00 —Å —à–∞–≥–æ–º 60 –º–∏–Ω—É—Ç)
            const allSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
            const availableSlots = allSlots.filter(slot => !takenTimes.includes(slot));

            if (availableSlots.length === 0) {
                container.innerHTML = '<p>–ù–∞ —ç—Ç—É –¥–∞—Ç—É –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.</p>';
                return;
            }

            availableSlots.forEach(time => {
                const button = document.createElement('span');
                button.className = 'time-slot';
                button.textContent = time;
                button.dataset.time = time;
                button.onclick = () => selectTimeSlot(time);
                container.appendChild(button);
            });

        } catch (error) {
            container.innerHTML = '<p class="error">–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—Ä–µ–º–µ–Ω–∏.</p>';
        }
    }

    /** –í—ã–±–∏—Ä–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–ª–æ—Ç */
    function selectTimeSlot(time) {
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
        const selectedSlot = document.querySelector(`.time-slot[data-time="${time}"]`);
        if (selectedSlot) {
            selectedSlot.classList.add('selected');
            document.getElementById('app-time').value = time;
        }
    }


    /** –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø) */
    document.getElementById('appointment-create-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideMessage('appointment-create-message');

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π DTO
        const clientName = document.getElementById('app-client-name').value;
        const clientPhone = document.getElementById('app-client-phone').value;

        const date = document.getElementById('app-date').value;
        const time = document.getElementById('app-time').value;
        const notes = document.getElementById('app-notes').value;

        if (!time) {
            showMessage('appointment-create-message', '–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏.', true);
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/appointments`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    // –ü–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç AppointmentCreateDto
                    clientName: clientName,
                    clientPhone: clientPhone,
                    appointmentDate: date,
                    appointmentTime: time,
                    notes: notes
                })
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('appointment-create-message', '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', false);
                document.getElementById('appointment-create-form').reset();
                loadAvailableTimes();
                loadMyAppointments();
            } else {
                // –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª 400 Bad Request —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
                showMessage('appointment-create-message', data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏', true);
            }
        } catch (error) {
            showMessage('appointment-create-message', '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏', true);
        }
    });

    /** –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–∏—Ö –∑–∞–ø–∏—Å–µ–π */
    async function loadMyAppointments() {
        const tbody = document.getElementById('my-appointments-table');
        tbody.innerHTML = '<tr><td colspan="4">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

        try {
            const response = await fetch(`${API_BASE_URL}/appointments/my`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                tbody.innerHTML = '<tr><td colspan="4" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π.</td></tr>';
                return;
            }

            const appointments = await response.json();
            tbody.innerHTML = '';

            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</td></tr>';
                return;
            }

            appointments.forEach(app => {
                const row = tbody.insertRow();
                row.insertCell().textContent = app.appointmentDate;
                row.insertCell().textContent = app.appointmentTime;

                row.insertCell().textContent = app.status;
                row.insertCell().textContent = app.notes || '-';
            });

        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="4" class="error">–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.</td></tr>';
        }
    }

    // --- Admin Functions ---

    /** –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    async function loadStatistics() {
        const container = document.getElementById('statistics');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>';

        try {
            const response = await fetch(`${API_BASE_URL}/admin/appointments/statistics`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                container.innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>';
                return;
            }

            const stats = await response.json();
            container.innerHTML = `
                    <div class="stat-box"><strong>${stats.total}</strong><br>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
                    <div class="stat-box"><strong>${stats.scheduled}</strong><br>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                    <div class="stat-box"><strong>${stats.completed}</strong><br>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                    <div class="stat-box"><strong>${stats.cancelled}</strong><br>–û—Ç–º–µ–Ω–µ–Ω–æ</div>
                `;
        } catch (error) {
            container.innerHTML = '<p class="error">–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>';
        }
    }

    /** –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π */
    async function loadAllAppointments() {
        const tbody = document.getElementById('all-appointments-table');
        tbody.innerHTML = '<tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

        try {
            const response = await fetch(`${API_BASE_URL}/admin/appointments`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                tbody.innerHTML = '<tr><td colspan="6" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–µ–π.</td></tr>';
                return;
            }

            const appointments = await response.json();
            tbody.innerHTML = '';

            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">–ó–∞–ø–∏—Å–µ–π –Ω–µ—Ç.</td></tr>';
                return;
            }

            appointments.forEach(app => {
                const row = tbody.insertRow();
                row.insertCell().textContent = app.id;
                row.insertCell().textContent = app.clientName ?? 'N/A';

                row.insertCell().textContent = app.appointmentDate;
                row.insertCell().textContent = app.appointmentTime;

                row.insertCell().textContent = app.status;

                const actionsCell = row.insertCell();

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
                const statusSelect = document.createElement('select');
                statusSelect.innerHTML = `
                        <option value="SCHEDULED" ${app.status === 'SCHEDULED' ? 'selected' : ''}>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</option>
                        <option value="COMPLETED" ${app.status === 'COMPLETED' ? 'selected' : ''}>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                        <option value="CANCELLED" ${app.status === 'CANCELLED' ? 'selected' : ''}>–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                    `;
                statusSelect.onchange = (e) => updateAppointmentStatus(app.id, e.target.value);
                actionsCell.appendChild(statusSelect);

                // –£–¥–∞–ª–µ–Ω–∏–µ
                const deleteButton = document.createElement('button');
                deleteButton.className = 'action-button delete';
                deleteButton.textContent = '–£–¥–∞–ª–∏—Ç—å';
                deleteButton.onclick = () => deleteAppointment(app.id);
                actionsCell.appendChild(deleteButton);
            });

        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="6" class="error">–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.</td></tr>';
        }
    }

    /** –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏ (Admin) */
    async function updateAppointmentStatus(id, newStatus) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ ${id} –Ω–∞ ${newStatus}?`)) return;

        try {
            const response = await fetch(`${API_BASE_URL}/admin/appointments/${id}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                alert('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                loadAllAppointments();
                loadStatistics();
            } else {
                const data = await response.json();
                alert(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞.');
        }
    }

    /** –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ (Admin) */
    async function deleteAppointment(id) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ${id}?`)) return;

        try {
            const response = await fetch(`${API_BASE_URL}/admin/appointments/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                loadAllAppointments();
                loadStatistics();
            } else {
                const data = await response.json();
                alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏.');
        }
    }

    // --- Admin User Management Functions ---

    /** –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (Admin) */
    async function loadAllUsers() {
        const tbody = document.getElementById('users-table');
        tbody.innerHTML = '<tr><td colspan="5">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

        try {
            const response = await fetch(`${API_BASE_URL}/auth/users`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                tbody.innerHTML = '<tr><td colspan="5" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</td></tr>';
                return;
            }

            const users = await response.json();
            tbody.innerHTML = '';
            const currentUserId = getCurrentUser().id;

            users.forEach(user => {
                const row = tbody.insertRow();
                row.insertCell().textContent = user.id;
                row.insertCell().textContent = user.name;
                row.insertCell().textContent = user.email;
                row.insertCell().textContent = user.role;

                const actionsCell = row.insertCell();

                // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏
                const roleSelect = document.createElement('select');
                roleSelect.innerHTML = `
                        <option value="USER" ${user.role === 'USER' ? 'selected' : ''}>USER</option>
                        <option value="ADMIN" ${user.role === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                    `;
                roleSelect.onchange = (e) => changeUserRole(user.id, e.target.value);
                actionsCell.appendChild(roleSelect);

                // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π –∞–¥–º–∏–Ω)
                if (user.id !== currentUserId) {
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'action-button delete';
                    deleteButton.textContent = '–£–¥–∞–ª–∏—Ç—å';
                    deleteButton.onclick = () => deleteUser(user.id);
                    actionsCell.appendChild(deleteButton);
                } else {
                    actionsCell.appendChild(document.createTextNode(' (–í—ã)'));
                }
            });

        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="5" class="error">–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.</td></tr>';
        }
    }

    /** –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Admin) */
    async function changeUserRole(userId, newRole) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –Ω–∞ ${newRole}?`)) return;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/users/${userId}/role`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ role: newRole })
            });

            if (response.ok) {
                alert('–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞!');
                loadAllUsers();
            } else {
                const data = await response.json();
                alert(`–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏.');
        }
    }

    /** –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Admin) */
    async function deleteUser(userId) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) return;

        try {
            const response = await fetch(`${API_BASE_URL}/auth/users/${userId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                loadAllUsers();
            } else {
                const data = await response.json();
                alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.');
        }
    }

    // Run initialization when the page loads
    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>